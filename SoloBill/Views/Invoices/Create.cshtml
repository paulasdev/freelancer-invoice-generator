@model SoloBill.ViewModels.InvoiceViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container-fluid px-4">
    <div class="row justify-content-between">
        <!-- Left Form -->
       
        <div class="col-lg-5 mb-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom-0">
                    <h4 class="mb-0 text-purple fw-bold">Create Invoice</h4>
                </div>
                <div class="card-body">
                
          <form asp-action="Create" method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <partial name="_ValidationScriptsPartial" />
    
    <input type="hidden" asp-for="Invoice.InvoiceId" />
    
    <div class="mb-3">
        <label asp-for="Invoice.ClientId" class="form-label">Client</label>
        <select asp-for="Invoice.ClientId" asp-items="ViewBag.ClientId" class="form-select" asp-option-label="-- Select a client --"></select>
        <span asp-validation-for="Invoice.ClientId" class="text-danger"></span>
    </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Invoice.IssueDate" class="form-label">Issue Date</label>
                                <input asp-for="Invoice.IssueDate" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Invoice.DueDate" class="form-label">Due Date</label>
                                <input asp-for="Invoice.DueDate" class="form-control" type="date" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">Notes</label>
                            <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
                        </div>

                        <h5 class="text-muted mb-2">Invoice Items</h5>
                        <div id="invoice-items">
                            @for (int i = 0; i < Model.Items.Count; i++)
                            {
                                <div class="row border rounded p-3 mb-3">
                                    <div class="col-12 mb-2">
                                        <input type="text" name="Items[@i].Description" value="@Model.Items[i].Description" class="form-control" placeholder="Item description" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Qty</label>
                                        <input type="text" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" class="form-control" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Rate</label>
                                        <input type="text" name="Items[@i].UnitPrice" value="@Model.Items[i].UnitPrice" class="form-control" />
                                    </div>
                                </div>
                            }
                        </div>

                        <button type="button" class="btn btn-outline-secondary w-100 mb-3" onclick="addItem()">+ Add Item</button>
                        <button type="submit" class="btn btn-purple w-100">Save Invoice</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Preview -->
        <div class="col-lg-7" id="preview">
            <div class="card shadow-lg border-0">
                <div class="card-body bg-white p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold">INVOICE</h3>
                          <p class="mb-0">#@Model.Invoice.InvoiceNumber</p>
                        @if (!string.IsNullOrEmpty(Model.LogoPath))
                        {
                            <img src="@Model.LogoPath" alt="Company Logo" style="height: 50px;" />
                        }
                    </div>

                  

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-0">Date: <strong>@Model.Invoice.IssueDate.ToString("dd MMMM, yyyy")</strong></p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="mb-0">Due Date: <strong>@Model.Invoice.DueDate.ToString("dd MMMM, yyyy")</strong></p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p class="fw-bold mb-1">Bill From:</p>
                            <p class="mb-0">@Model.CompanyName</p>
                            <p class="mb-0">@Model.Address</p>
                            <p class="mb-0">@Model.CompanyPhone</p>
                            <p class="mb-0">@Model.Email</p>
                        </div>
                        <div class="col-md-6">
                            <p class="fw-bold mb-1">Bill To:</p>
                            <p class="mb-0">@Model.Client?.Name</p>
                            <p class="mb-0">@Model.Client?.Company</p>
                            <p class="mb-0">@Model.Client?.Address</p>
                            <p class="mb-0">@Model.Client?.Email</p>
                        </div>
                    </div>

                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Rate</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>@item.Description</td>
                                    <td>@item.Quantity</td>
                                    <td>@("\u20ac" + item.UnitPrice.ToString("N2"))</td>
                                    <td>@("\u20ac" + item.Total.ToString("N2"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <p class="text-end fw-bold">Total: â‚¬@Model.Items.Sum(i => i.Quantity * i.UnitPrice).ToString("N2")</p>

                    <div class="bg-light p-3 rounded mt-4">
                        <p class="fw-bold mb-1">Payment Method</p>
                        <p class="mb-1">Bank: @Model.BankName</p>
                        <p class="mb-1">IBAN: @Model.IBAN</p>
                        <p class="mb-1">BIC: @Model.BIC</p>
                        @if (!string.IsNullOrEmpty(Model.Notes))
                        {
                            <p class="mb-1"><strong>Note:</strong> @Model.Notes</p>
                        }
                    </div>
                    <p class="text-muted small mt-4">Invoice was created on a computer and is valid without signature and seal.</p>
              </div>
<div class="mt-4 d-flex justify-content-end gap-3">
    @if (Model.Invoice.InvoiceId > 0)
    {
        <a asp-action="ExportToPdf" asp-controller="Invoices" asp-route-id="@Model.Invoice.InvoiceId" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Download PDF
        </a>
    }
<button type="button" onclick="printInvoice()" class="btn btn-outline-secondary">
    <i class="bi bi-printer"></i> Print
</button>
</div>
            </div>

        </div>



@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
function addItem() {
        const container = document.getElementById('invoice-items');
        const index = container.children.length;

        const item = document.createElement('div');
        item.classList.add('row', 'border', 'rounded', 'p-3', 'mb-3', 'position-relative');
        item.innerHTML = `
            <div class="col-12 mb-2">
                <input type="text" name="Items[${index}].Description" class="form-control" placeholder="Item description" />
            </div>
            <div class="col-6">
                <label class="form-label">Qty</label>
                <input type="text" name="Items[${index}].Quantity" class="form-control" />
            </div>
            <div class="col-6">
                <label class="form-label">Rate</label>
                <input type="text" name="Items[${index}].UnitPrice" class="form-control" />
            </div>
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="removeItem(this)"></button>
        `;
        container.appendChild(item);
    }

    function removeItem(button) {
        const item = button.closest('.row');
        item.remove();
    }
    
        function printInvoice() {
    const invoiceContent = document.getElementById('preview').cloneNode(true); 
    const printWindow = window.open('', '', 'width=900,height=650');
    printWindow.document.write(`
        <html>
        <head>
            <title>Print Invoice</title>
            <style>
                body { font-family: 'Inter', sans-serif; padding: 2rem; background: #fff; color: #2d2d2d; }
                h3, h4, p { margin: 0 0 8px; }
                table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
                th, td { padding: 6px 8px; text-align: left; }
                th { background-color: #f8f9fa; }
                .text-end { text-align: right; }
                .fw-bold { font-weight: bold; }
                .bg-light { background-color: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 1rem; }
                .small { font-size: 0.8rem; color: #6c757d; margin-top: 1rem; }
                img { max-height: 50px; margin-bottom: 10px; }
                .btn, .gap-3, .d-flex.justify-content-end { display: none !important; }
            </style>
        </head>
        <body>${invoiceContent.innerHTML}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.onload = () => {
        printWindow.print();
        printWindow.close();
    };
}
    </script>
}
